var vid = document.getElementById('videoel');
var overlay = document.getElementById('overlay');
var webGLCanvas = document.getElementById('webgl');
var imgCanvasEl = document.getElementById('img-canvas');
var overlayCC = overlay.getContext('2d');

var ctrack = new clm.tracker({useWebGL : true});
ctrack.setResponseMode("cycle", ["lbp", "sobel"]);
ctrack.init(pModel);

var mapping, ctrackBG;

var ctx = imgCanvasEl.getContext("2d");
var imageObj = new Image();
imageObj.onload = function() {
  ctx.drawImage(imageObj, 0, 0);
  //mapping = [[644.360477105395,512.0189088438915],[642.0750227026704,531.6014329292829],[643.6676393674884,549.3857387439032],[648.0828720848373,567.3016886343365],[657.6026260574034,582.7129381081119],[671.3454195044783,594.4776694600848],[688.1225676145957,602.4121088191067],[706.013563987786,605.275755151926],[720.0975106908905,601.6263051934264],[729.4144704388966,592.0216336919481],[736.1463754840025,579.4405473011327],[740.6761393429604,564.7755087558137],[744.028985890189,548.6462215899154],[745.8769542596912,531.9717365975255],[745.120731288017,514.3152817294826],[741.5011393235723,499.15945227479085],[736.4593948066525,495.4594407082978],[726.1679608660847,495.22447453989076],[717.8270469220502,496.8305954808431],[663.1399174501989,496.61294232243483],[673.0459999650847,492.61823223649577],[685.9139094566798,493.206926304507],[695.2051336890911,495.5865529791694],[669.6630511030269,507.21560057293425],[679.9779518733551,502.08071023962145],[689.2573442428297,507.5781315516265],[679.5348376705875,509.52392493099603],[679.3120479196698,505.821697486839],[735.73887609706,509.8894788096196],[728.1781243318334,504.2286681537755],[717.9040959687178,508.549078572054],[727.5408305704171,511.4033004302936],[727.0108990904948,507.7937788008275],[707.1053056076753,504.60929832843505],[697.3634524781477,524.5061269290449],[691.5992047848835,533.0846431305218],[696.2401711863704,539.0245878586078],[709.5958955797082,539.9539149072365],[718.3443925446711,539.2605543428647],[722.2891751494733,533.7869284892665],[718.5564150987287,525.1077404881411],[710.084532849586,517.3020797590058],[701.9609164145428,534.056676399611],[717.0064439977438,535.3294384149835],[685.7070817913147,562.4911327234352],[693.7614800727924,555.3042145364627],[702.8433627601783,552.2133250796004],[708.2039890824999,553.4108588019928],[713.1497855136105,552.4652213169504],[718.9753898968416,555.749701282483],[721.5057419280155,563.1000159568863],[718.8261666431706,567.9408036805163],[714.3827745274867,570.991058521],[707.2541736980684,571.7329690257745],[698.449457759423,570.6922887792949],[691.0936484478269,567.6117030160444],[696.8914231102827,564.5859144404754],[707.1330869424643,565.9561314870257],[714.9398688068048,565.0241327923819],[715.4541231182491,558.0207751093437],[707.6746691025953,557.4113885714498],[697.1597389311896,557.7322814180261],[712.4258903996779,529.7791457349676],[673.9727883554312,503.4354827288645],[685.7379245483917,503.7994354310022],[684.691617253936,508.7674208023887],[674.3271651701446,508.71182418861974],[733.0998871812992,506.04827882698976],[722.339025342058,505.26223941516935],[722.6067831189398,510.18819695872816],[732.1953154202905,510.9909179926045]];

  //201-170
  mapping = [[856.5860375081108,298.1334824958572],[856.9137602034751,304.5436226612355],[858.5133858908172,310.7570678147904],[860.8981589140595,316.94615787471866],[864.2136143468241,322.0182745451077],[868.4060974725217,326.05743604050286],[873.128415496726,329.2647822410264],[878.6718026011926,329.89849392372224],[882.999023632465,328.53354816017935],[887.4748356511112,324.49004593135857],[889.1435176848909,320.03845684006586],[890.8637480427052,314.5285800273316],[891.750363288669,307.9285501810092],[891.6408513893824,300.3398476289482],[891.9895219405847,294.80025156099657],[889.440840905661,290.7672604184595],[885.8594298702959,290.079538719348],[881.2124384971416,291.13016397854733],[877.7492822372194,292.5054753730574],[859.2103686259929,294.81746399446996],[861.6874879973304,293.4048746871428],[866.0799958506598,293.21079522766155],[869.6307197174925,293.61614886174897],[862.3042636620147,298.48357674450745],[865.4043389579564,296.45885510812684],[869.4274719548712,297.71009908720373],[865.7813868437435,299.08271804873766],[865.7498341851161,297.58994737671566],[887.2380874515012,295.0897656900578],[883.2752414904808,294.0132708777869],[879.8707169759641,296.33171197538024],[883.7283985417672,296.6668224805339],[883.498303581631,295.1867289943281],[874.0427691176861,296.0433824888491],[871.0132598637413,305.0751225996596],[869.8197236818099,308.1483301012378],[871.5582263666039,309.9492361341998],[875.60092794098,310.41214690866167],[880.0323911769549,308.8978300809354],[881.3899791105781,306.6343871991642],[879.1777558668831,303.975732696582],[874.4175781043956,301.94617140728553],[872.3937081047875,309.121947205257],[878.417895881065,308.20694373712075],[869.7232355140605,316.7068381007473],[871.8406559972747,315.0793671635991],[874.3557804924764,314.29077683508575],[876.2635922958397,314.4756355467175],[878.1340907895234,313.7915650418895],[881.197206234168,313.8840233343199],[884.4378341236566,314.8319460927556],[882.7161063319764,317.3551682509255],[880.299105568589,319.14200466435346],[877.0757901731341,319.9935808028668],[873.9478365281267,319.92717177090753],[871.6090727096862,318.7299037580572],[873.2969496481447,317.35525310672],[876.7724096933086,317.41423389538613],[880.4528136156634,316.44821832895263],[880.2199225757827,315.16554341705614],[876.5145891922565,315.8645726561573],[873.1070890014324,316.07922639281907],[874.8310984298294,307.4981109607489],[863.4953518356165,297.1681009150362],[867.6717708070491,296.6155294354955],[867.6951590215259,298.5017352705633],[863.8736264679536,298.99699849571743],[885.477447674823,294.158373458882],[881.1507987836115,294.80269892771736],[881.706166709911,296.61407813343783],[885.6461139122817,296.06265032753464]];

  //spectator.jpg
  mapping = [[513.1988315437877,758.8749260184848],[511.3606037317214,776.2804166574508],[509.84787721827,809.8327362268648],[515.143037299865,838.1212203283025],[532.3800993319039,856.8310273329847],[551.5403815060364,865.3364976007981],[572.7682385728028,869.6682105570261],[598.6956664946777,869.858515300179],[618.5516136550166,872.2975206968863],[646.8026126006871,867.4873594351266],[662.6853825678551,855.5844784992487],[669.4498693658286,827.5443342715074],[674.4920193497704,804.7660259977362],[675.6425830398082,781.9706805059234],[672.6067026222903,757.4494030454183],[652.3938069373784,734.0944502352077],[641.0229395104901,725.7375831221727],[623.6390484562907,724.5554644179766],[610.4692904134043,727.1142519905173],[543.2939472617746,732.9229729468151],[551.687041826399,725.3136132077522],[567.5081451430568,724.1745588379819],[580.1662826902627,726.7992800403282],[544.9636548049615,755.1051940896161],[562.3150208931653,743.7506533245446],[576.6320118442842,749.4137775194386],[562.9861974167435,753.5061761991146],[563.235650215861,748.8584461065556],[644.0855819312283,754.0186246816204],[630.2233870056815,743.9698325184306],[616.7387973930023,749.7723023466441],[630.0001461965534,753.7935026603673],[629.6151035627337,749.1375771598138],[595.4841827523196,741.3201586316404],[580.2203615614385,769.5168529991256],[572.100422661395,783.9788304560832],[579.0194091364411,791.7765323368543],[595.1489919388712,789.590157290478],[613.672840912744,793.5907857865093],[619.4903959980261,784.2721483579226],[610.9114179810574,769.9330679480727],[594.5914004548789,757.9464297385238],[586.7660147499026,782.9306849413409],[605.8600821998041,782.1158853360315],[566.4448953568348,826.2575898694807],[577.8366285139009,811.3175549696194],[588.3500777339173,806.9219558450457],[595.7694853665452,808.4808541742339],[603.5687095102347,806.9013740047993],[615.5547045001152,811.4675415695631],[627.2371192472809,824.2453850784119],[619.1175985437945,828.013166076911],[608.9974455576156,832.1407368936827],[596.4584048538142,833.0632530747448],[584.6048169071258,831.8060183882271],[575.653927449538,830.3255267539067],[582.9746984492026,824.1904276516761],[596.5470871327144,824.3778808652788],[611.1001508037644,823.4171360566157],[610.8362821274832,815.5254531150323],[596.1661644200303,814.5929224631673],[582.5221294232487,815.4366759714467],[593.8056251425724,774.0167568523998],[555.2716915735424,746.1288743671207],[570.4414261803502,745.1906152881874],[570.1560827504208,751.9452196704906],[556.3830903817278,752.7933071347629],[637.9660833941168,746.3532571949946],[622.3079989353313,745.4956455097457],[622.8868008275333,752.1967712768515],[637.1421381764648,753.1404548622143]];

  //092613_fire_Sep262013_5397_1_8442.jpg
  mapping = [[854.3989223503962,458.29020981166053],[855.1663987107077,464.497425995894],[855.9142581878176,471.7645986399517],[856.3755740503639,479.0010789916202],[860.0574476331705,484.1809387563034],[865.2147856857414,487.7726798441733],[871.3931365073423,489.9539376539888],[877.7487193781595,490.33840804326405],[883.1155753126168,488.7257096350718],[889.6812594016351,487.80301958623755],[892.2111303865945,482.4828172743023],[894.4126709954079,477.1063086950872],[895.906220554358,469.85573473525744],[896.0844419581139,463.33692858684],[895.4337401253064,456.5302818255742],[889.4958237568604,451.39730932463266],[886.9798085187049,449.75861631699564],[882.6059265060283,449.9608372344646],[879.1624292288425,450.98601863896215],[858.886974972679,453.84400380645974],[862.2354657858116,451.5569676171054],[867.172838322751,451.080496196379],[870.9527708486718,451.58741748812326],[862.0311371117195,458.06272998995166],[865.7276056232957,455.9593354134622],[869.5813327418339,457.2915377855727],[865.9109782493744,458.59064491638446],[865.8361270297895,457.24653919353443],[887.4372528260899,456.21289779427104],[884.1403725692181,454.6326341827622],[880.2652828415074,456.43959935379723],[884.1687466216854,457.23182025128824],[883.9499444884015,455.9129131243259],[875.4048996475269,454.9038387801422],[871.9830649409233,463.2335867734447],[870.2053159139737,466.43906529045046],[872.095887382361,468.4381294384556],[876.8850880727413,468.28816183161206],[880.7405366860204,467.68844438703127],[882.0999865368191,465.55034832425423],[880.2383358211114,462.63194879834987],[876.3386917288142,459.80222046052205],[873.89202334103,466.5775056821248],[879.5041922351194,466.3144964564453],[868.7969533048873,476.3503320722826],[871.8029692851376,473.90627794812536],[874.9830132918127,472.65646801047535],[877.0333146537645,472.9263016957593],[878.8903973621664,472.3600803455179],[881.5942593621673,473.10206684260675],[883.7957131723061,475.1336201146813],[882.3495367515061,477.0618110204091],[880.3443902082762,478.33050006022194],[877.327261366865,478.91453945174226],[873.937195590013,478.8958199486147],[871.0855683660537,478.04064862149727],[873.1275627446968,476.46127957939325],[877.0854281178945,476.4164844478929],[880.5225894432318,475.8399536633403],[880.486735795226,474.3477274629036],[877.034332253684,474.5039542241502],[873.0930132103197,474.9530402416778],[877.1525830411847,464.47888924929424],[863.5920275603016,456.68025166213164],[867.9615874690778,456.2173316161412],[867.8821985703614,458.0444608941731],[863.8719773116002,458.5190673121688],[886.1064327984011,455.0667412708075],[881.9219038271716,455.1602784747734],[882.1501323353933,456.97171540556695],[886.0114080827008,456.87250036682946]];
  //mapping = [[57.91599883398756,87.73631902941587],[56.93093260839211,94.07987946317772],[57.432709568973294,100.23035166588619],[59.10616578221365,106.77549285421995],[62.795051305800826,112.11338533161938],[67.98079344876595,116.0716108490223],[74.13086738298634,118.85475081458628],[80.18310972684314,119.69172817822229],[84.65303128240802,118.36262795219173],[87.62533506360218,114.79284917357018],[90.13492712842739,110.61235899252281],[91.96531156588088,105.76797239824218],[93.32367763097392,100.23227651671448],[94.0808387679603,94.52880550396252],[93.72380614394632,88.71616041849089],[92.99366314229964,84.99071234205357],[91.38049869296384,83.85715009612721],[87.7515035738124,83.90325580928663],[84.7053964037019,84.54611598157969],[65.38264980049686,84.61338674091805],[69.1642365068552,83.24115662379644],[73.87628500215679,83.49974682934493],[77.31871513814174,84.32546431659662],[68.06395636008605,88.28763603139409],[71.91883341955705,86.74165020031114],[75.06605006462794,88.59034631451375],[71.70103408592593,89.32929392527086],[71.67015217026295,87.9445503988874],[90.81402092054506,88.88078184626406],[88.24858167209871,87.21064823987643],[84.60301560576674,88.71448171981024],[88.04182079508847,89.70723296139803],[87.86551078009745,88.35121417422431],[81.1373973146789,87.40765990386276],[77.52649394831079,95.1502949389077],[75.48666147500724,97.89728030231382],[77.12818891874738,99.92648746282579],[81.93300084971703,100.56325086404365],[84.95874204056717,99.88624395202675],[86.25098449704087,98.08944063440606],[85.02455738799142,95.31993777742841],[82.20763404611318,92.63790970763793],[79.16498214553951,98.72682581686061],[84.55682123049836,99.14101264782124],[72.85445018842785,106.34455899811913],[76.3638289431955,104.84114765869236],[79.56867180980997,104.21904992765857],[81.4303910719181,104.65756091379993],[83.07007240721168,104.2738673497946],[85.01496653743662,104.8725343263891],[86.2699883355957,106.40230425968835],[85.17842345959139,108.35499281030306],[83.63321789279131,109.68327047510019],[81.04248263118265,110.08902779427403],[77.81514631750106,109.72197128747345],[74.99920886309661,108.4178300029152],[77.22949639544292,107.26166808416116],[80.98095992436171,107.69210696903738],[83.79248231988338,107.26955106294282],[83.95124746530965,105.9205081591138],[81.19328651072934,105.9903320513551],[77.41495332154958,105.8968483131911],[83.05943588404979,97.55837928511542],[69.7925784252129,87.14750582078085],[73.89205731142403,87.28757778771424],[73.52333464915748,89.05491126839254],[69.79962652265633,88.99673758306665],[89.88385090106226,87.73435978058919],[86.1978190731054,87.55129102187371],[86.27035002862607,89.33035516275856],[89.65575268211067,89.4580658902295]];
  //ctrackBG = new clm.tracker({useWebGL : true});
  //ctrackBG.init(pModel);
  //setTimeout(function(){
    ////ctrackBG.start(imgCanvasEl);
    //mapping = ctrackBG.track(imgCanvasEl);
    ////console.log(mapping);
    ////mapping = ctrackBG.getCurrentPosition();
  //}, 2000);
};
imageObj.src = "/092613_fire_Sep262013_5397_1_8442.jpg";


var fd = new faceDeformer();
fd.init(webGLCanvas);

navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

// check for camerasupport
if (navigator.getUserMedia) {
  // set up stream

  var videoSelector = {video : true};
  if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
    var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
    if (chromeVersion < 20) {
      videoSelector = "video";
    }
  };

  navigator.getUserMedia(videoSelector, function( stream ) {
    if (vid.mozCaptureStream) {
      vid.mozSrcObject = stream;
    } else {
      vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
    }
    //startVideo();
    vid.play();
  }, function() {
    console.log("can't start webcam");
  });
}

vid.addEventListener('canplay', startVideo, false);

function startVideo() {
  // start video
  vid.play();
  // start tracking
  ctrack.start(vid);
  // start loop to draw face
  drawLoop();
}

function drawLoop() {
  requestAnimationFrame(drawLoop);
  overlayCC.clearRect(0, 0, 400, 300);
  var positions = ctrack.getCurrentPosition();

  if (positions && mapping && ctrack.getScore() > .5) {
    //ctrackBG.draw(overlay);
    fd.load(vid, positions, pModel);
    fd.draw(mapping);
  }
}
